<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>License Plate API - Swagger UI</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/4.18.3/swagger-ui.css" />
    <style>
      html {
        box-sizing: border-box;
        overflow: -moz-scrollbars-vertical;
        overflow-y: scroll;
      }
      
      *,
      *:before,
      *:after {
        box-sizing: inherit;
      }
      
      body {
        margin: 0;
        background: #fafafa;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      }
      
      .topbar {
        padding: 10px 30px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .api-id-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      #api-id {
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        width: 250px;
      }
      
      .btn {
        background-color: #4f46e5;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      
      .btn:hover {
        background-color: #4338ca;
      }
      
      .btn-secondary {
        background-color: #6b7280;
      }
      
      .btn-secondary:hover {
        background-color: #4b5563;
      }
      
      .script-output {
        background-color: #272822;
        color: #f8f8f2;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
        display: none;
      }
      
      .swagger-ui .topbar {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <h2>License Plate API</h2>
      <div class="api-id-container">
        <button id="get-api-id" class="btn">Get API ID</button>
        <input type="text" id="api-id" placeholder="Your API ID will appear here" />
        <button id="update-swagger" class="btn">Update Swagger</button>
        <button id="toggle-script" class="btn btn-secondary">Show/Hide Script</button>
      </div>
    </div>

    <div id="script-output" class="script-output"></div>
    <div id="swagger-ui"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/4.18.3/swagger-ui-bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/4.18.3/swagger-ui-standalone-preset.js"></script>
    <script>
      // Store the OpenAPI specification
      let spec = {
        openapi: '3.0.0',
        info: {
          title: 'License Plate Processing API',
          description: 'API for processing license plate readings and querying metrics',
          version: '1.0.0',
          contact: {
            name: 'API Support',
            email: 'support@example.com'
          }
        },
        servers: [
          {
            url: 'http://localhost:4566/restapis/{apiId}/dev/_user_request_',
            description: 'LocalStack API Gateway',
            variables: {
              apiId: {
                description: "The API Gateway ID (run 'Get API ID' script first)",
                default: 'YOUR_API_ID_HERE'
              }
            }
          }
        ],
        tags: [
          {
            name: 'Readings',
            description: 'API endpoints for processing license plate readings'
          },
          {
            name: 'Metrics',
            description: 'API endpoints for querying metrics'
          }
        ],
        paths: {
          '/readings': {
            post: {
              tags: ['Readings'],
              summary: 'Process a license plate reading',
              description: 'Submit a license plate reading to be processed according to campaign rules',
              operationId: 'processReading',
              requestBody: {
                required: true,
                content: {
                  'application/json': {
                    schema: {
                      $ref: '#/components/schemas/LicensePlateReading'
                    }
                  }
                }
              },
              responses: {
                200: {
                  description: 'Successfully processed reading',
                  content: {
                    'application/json': {
                      schema: {
                        $ref: '#/components/schemas/ProcessingResult'
                      }
                    }
                  }
                },
                400: {
                  description: 'Invalid input',
                  content: {
                    'application/json': {
                      schema: {
                        $ref: '#/components/schemas/Error'
                      }
                    }
                  }
                },
                409: {
                  description: 'Conflict - Duplicate reading ID',
                  content: {
                    'application/json': {
                      schema: {
                        $ref: '#/components/schemas/Error'
                      }
                    }
                  }
                },
                500: {
                  description: 'Server error',
                  content: {
                    'application/json': {
                      schema: {
                        $ref: '#/components/schemas/Error'
                      }
                    }
                  }
                }
              }
            }
          },
          '/metrics': {
            get: {
              tags: ['Metrics'],
              summary: 'Query metrics about readings and ad exposures',
              description: 'Get statistics about license plate readings and ad exposures',
              operationId: 'getMetrics',
              parameters: [
                {
                  name: 'limit',
                  in: 'query',
                  description: 'Maximum number of recent exposures to return',
                  required: false,
                  schema: {
                    type: 'integer',
                    minimum: 1,
                    maximum: 100,
                    default: 10
                  }
                }
              ],
              responses: {
                200: {
                  description: 'Successfully retrieved metrics',
                  content: {
                    'application/json': {
                      schema: {
                        $ref: '#/components/schemas/Metrics'
                      }
                    }
                  }
                },
                400: {
                  description: 'Invalid parameters',
                  content: {
                    'application/json': {
                      schema: {
                        $ref: '#/components/schemas/Error'
                      }
                    }
                  }
                },
                500: {
                  description: 'Server error',
                  content: {
                    'application/json': {
                      schema: {
                        $ref: '#/components/schemas/Error'
                      }
                    }
                  }
                }
              }
            }
          }
        },
        components: {
          schemas: {
            Location: {
              type: 'object',
              required: ['latitude', 'longitude'],
              properties: {
                latitude: {
                  type: 'number',
                  format: 'double',
                  minimum: -90,
                  maximum: 90,
                  description: 'Geographic latitude',
                  example: 37.7749
                },
                longitude: {
                  type: 'number',
                  format: 'double',
                  minimum: -180,
                  maximum: 180,
                  description: 'Geographic longitude',
                  example: -122.4194
                }
              }
            },
            LicensePlateReading: {
              type: 'object',
              required: ['reading_id', 'timestamp', 'license_plate', 'checkpoint_id', 'location'],
              properties: {
                reading_id: {
                  type: 'string',
                  description: 'Unique identifier for the reading',
                  example: 'READ123'
                },
                timestamp: {
                  type: 'string',
                  format: 'date-time',
                  description: 'Time when the reading occurred (ISO 8601 format)',
                  example: '2023-06-10T14:30:00Z'
                },
                license_plate: {
                  type: 'string',
                  description: 'License plate number',
                  example: 'ABC123'
                },
                checkpoint_id: {
                  type: 'string',
                  description: 'Identifier for the checkpoint',
                  example: 'CHECK_01'
                },
                location: {
                  $ref: '#/components/schemas/Location'
                }
              }
            },
            AdServed: {
              type: 'object',
              required: ['campaign_id', 'ad_content'],
              properties: {
                campaign_id: {
                  type: 'string',
                  description: 'Identifier for the campaign',
                  example: 'CAMP_001'
                },
                ad_content: {
                  type: 'string',
                  description: 'Identifier for the ad content',
                  example: 'AD_001'
                }
              }
            },
            ProcessingResult: {
              type: 'object',
              required: ['reading_id', 'processed'],
              properties: {
                reading_id: {
                  type: 'string',
                  description: 'Identifier for the processed reading',
                  example: 'READ123'
                },
                processed: {
                  type: 'boolean',
                  description: 'Whether the reading was successfully processed',
                  example: true
                },
                ad_served: {
                  type: 'object',
                  nullable: true,
                  description: 'Information about the ad served (null if no ad was applicable)',
                  allOf: [
                    {
                      $ref: '#/components/schemas/AdServed'
                    }
                  ]
                }
              }
            },
            CheckpointReading: {
              type: 'object',
              required: ['checkpoint_id', 'total_readings'],
              properties: {
                checkpoint_id: {
                  type: 'string',
                  description: 'Identifier for the checkpoint',
                  example: 'CHECK_01'
                },
                total_readings: {
                  type: 'integer',
                  description: 'Total number of readings at this checkpoint',
                  example: 5
                }
              }
            },
            CampaignAd: {
              type: 'object',
              required: ['campaign_id', 'total_ads_shown'],
              properties: {
                campaign_id: {
                  type: 'string',
                  description: 'Identifier for the campaign',
                  example: 'CAMP_001'
                },
                total_ads_shown: {
                  type: 'integer',
                  description: 'Total number of ads shown for this campaign',
                  example: 7
                }
              }
            },
            Exposure: {
              type: 'object',
              required: ['exposure_id', 'campaign_id', 'ad_content', 'timestamp', 'reading_id', 'license_plate', 'checkpoint_id'],
              properties: {
                exposure_id: {
                  type: 'integer',
                  description: 'Unique identifier for the exposure',
                  example: 7
                },
                campaign_id: {
                  type: 'string',
                  description: 'Identifier for the campaign',
                  example: 'CAMP_001'
                },
                ad_content: {
                  type: 'string',
                  description: 'Identifier for the ad content',
                  example: 'AD_001'
                },
                timestamp: {
                  type: 'string',
                  format: 'date-time',
                  description: 'Time when the ad was shown',
                  example: '2023-06-10T14:30:00Z'
                },
                reading_id: {
                  type: 'string',
                  description: 'Identifier for the reading',
                  example: 'READ123'
                },
                license_plate: {
                  type: 'string',
                  description: 'License plate number',
                  example: 'ABC123'
                },
                checkpoint_id: {
                  type: 'string',
                  description: 'Identifier for the checkpoint',
                  example: 'CHECK_01'
                }
              }
            },
            Metrics: {
              type: 'object',
              required: ['readings_by_checkpoint', 'ads_by_campaign', 'recent_exposures', 'metadata'],
              properties: {
                readings_by_checkpoint: {
                  type: 'array',
                  description: 'Total readings per checkpoint',
                  items: {
                    $ref: '#/components/schemas/CheckpointReading'
                  }
                },
                ads_by_campaign: {
                  type: 'array',
                  description: 'Total ads shown per campaign',
                  items: {
                    $ref: '#/components/schemas/CampaignAd'
                  }
                },
                recent_exposures: {
                  type: 'array',
                  description: 'List of recent ad exposures',
                  items: {
                    $ref: '#/components/schemas/Exposure'
                  }
                },
                metadata: {
                  type: 'object',
                  required: ['limit_applied'],
                  properties: {
                    limit_applied: {
                      type: 'integer',
                      description: 'Limit applied to recent exposures',
                      example: 5
                    }
                  }
                }
              }
            },
            Error: {
              type: 'object',
              required: ['error'],
              properties: {
                error: {
                  type: 'string',
                  description: 'Error message',
                  example: 'Invalid timestamp: must be in ISO 8601 format'
                }
              }
            }
          }
        }
      }
      
      // Function to get API ID from LocalStack
      async function getApiId() {
        const scriptOutput = document.getElementById('script-output')
        scriptOutput.style.display = 'block'
        scriptOutput.innerHTML = 'Fetching API ID from LocalStack...\n'
      
        try {
          // Simulate the command that would be run in Docker
          scriptOutput.innerHTML += 'Running: docker exec localstack aws --endpoint-url=http://localhost:4566 apigateway get-rest-apis\n'
      
          // In a real scenario, this would make an actual fetch to an endpoint that executes the Docker command
          // For this demo, we'll simulate the response with a timeout
          await new Promise((resolve) => setTimeout(resolve, 1500))
      
          // Simulated response
          const simulatedApiId = 'abc123def456'
          document.getElementById('api-id').value = simulatedApiId
      
          scriptOutput.innerHTML += `API ID found: ${simulatedApiId}\n`
          scriptOutput.innerHTML += 'You can now use this API ID in your Swagger UI.\n'
      
          return simulatedApiId
        } catch (error) {
          scriptOutput.innerHTML += `Error fetching API ID: ${error.message}\n`
          scriptOutput.innerHTML += 'Please check that your LocalStack and API Gateway are running properly.\n'
          return null
        }
      }
      
      // Function to update the Swagger UI with the new API ID
      function updateSwaggerUi(apiId) {
        if (!apiId) return
      
        // Update the server URL with the new API ID
        const updatedSpec = JSON.parse(JSON.stringify(spec))
        updatedSpec.servers[0].variables.apiId.default = apiId
      
        // Re-initialize the Swagger UI
        ui.specActions.updateSpec(JSON.stringify(updatedSpec))
      }
      
      // Initialize Swagger UI
      const ui = SwaggerUIBundle({
        spec: spec,
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
        plugins: [SwaggerUIBundle.plugins.DownloadUrl],
        layout: 'StandaloneLayout'
      })
      
      // Add event listeners
      document.getElementById('get-api-id').addEventListener('click', getApiId)
      
      document.getElementById('update-swagger').addEventListener('click', function () {
        const apiId = document.getElementById('api-id').value
        if (!apiId) {
          alert('Please get or enter an API ID first')
          return
        }
        updateSwaggerUi(apiId)
      })
      
      document.getElementById('toggle-script').addEventListener('click', function () {
        const scriptOutput = document.getElementById('script-output')
        scriptOutput.style.display = scriptOutput.style.display === 'none' ? 'block' : 'none'
      })
    </script>
  </body>
</html>
